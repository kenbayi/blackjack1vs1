# Документация Dueljack

## 1. Общая информация

Эта документация описывает серверную часть карточной игры "Dueljack", разработанную на языке **Go** с использованием **PostgreSQL** для хранения данных, **Redis** для управления игровыми сессиями и **WebSockets** для взаимодействия между игроками в реальном времени.

------

## 2. Структура проекта

Проект состоит из следующих директорий и файлов:

### Корневая директория:

- **`server.go`** — Основной серверный файл.
- **`go.mod` и `go.sum`** — Файлы управления зависимостями Go.
- **`config/`** — Содержит файлы конфигурации (например, параметры базы данных и Redis).
- **`dump.rdb`** — База данных Redis.
- **`src/`** — Исходный код проекта.

### Директория `src/`:

- **`models/`** — Содержит структуры данных (пользователи, игровые комнаты и т. д.).
- **`db/`** — Отвечает за взаимодействие с PostgreSQL и Redis.
- **`handlers/`** — Обработчики API и соединений WebSocket.
- **`middlewares/`** — Вспомогательные функции (логирование, аутентификация и др.).

------

## 3. Модели данных

### 3.1 Пользователь (**models/user.go**)

```go
type User struct {
	ID        int       `json:"id"`         // Уникальный идентификатор
	Username  string    `json:"username"`   // Имя пользователя
	Password  string    `json:"-"`          // Захешированный пароль (не отображается в JSON)
	CreatedAt time.Time `json:"created_at"` // Дата создания аккаунта
	Balance   int       `json:"balance"`    // Баланс пользователя
}
```

### 3.2 Игровая комната (**models/room.go**)

```go
type GameRoom struct {
	ID        int       `json:"id"`         // Уникальный идентификатор
	RoomID    string    `json:"room_id"`    // UUID комнаты
	Player1ID int       `json:"player1_id"` // ID первого игрока
	Player2ID int       `json:"player2_id"` // ID второго игрока
	Status    string    `json:"status"`     // Статус комнаты: "finished"
	Winner    string    `json:"winner"`     // Победитель комнаты
	CreatedAt time.Time `json:"created_at"` // Дата и время создания комнаты
}
```

------

## 4. API-эндпоинты

### 4.1 Аутентификация

#### `POST /register`

Регистрация нового пользователя.

- **Тело запроса:**

```json
{
  "username": "новыйИгрок",
  "password": "пароль"
}
```

- **Ответ в переводе с английского:**

```json
{
  "message": "Пользователь успешно зарегистрирован"
}
```

- Ошибки:
  - `400 Bad Request` — Имя пользователя уже существует.

#### `POST /login`

Аутентификация пользователя.

- **Тело запроса:**

```json
{
  "username": "игрок1",
  "password": "пароль"
}
```

- **Ответ:**

```json
{
  "token": "uuid-токен-сессии"
}
```

- Ошибки:
  - `401 Unauthorized` — Неверный логин или пароль.

#### `POST /logout`

Выход из системы и завершение сессии.

- **Тело запроса:**

```json
{
  "token": "uuid-токен-сессии"
}
```

- **Ответ в переводе с английского:**

```json
{
  "message": "Пользователь успешно вышел из системы"
}
```

------

### 4.2 Управление пользователями

#### `GET /user/{username}`

Получение данных пользователя по имени.

- **Ответ:**

```json
{
  "id": 1,
  "username": "player1",
  "created_at": "2024-02-20T15:30:00Z",
  "balance": 5000
}
```

#### `PUT /updProfile`

Обновление данных профиля пользователя.

- **Тело запроса:**

```json
{
  "user_id": 1,
  "username": "новоеИмя"
}
```

- **Ответ в переводе с английского:**

```json
{
  "message": "Профиль успешно обновлён"
}
```

------

### 4.5 WebSockets

#### `GET /ws`

Установка WebSocket-соединения для управления игровым процессом в реальном времени.

- **Описание:** Этот эндпоинт используется для организации связи между игроками в одной игровой комнате.

------

## 5. Веб-сокет сообщения

### 5.1 Структура WebSocket-сообщения

```json
{
  "type": "hit",
  "content": {
    "roomID": "uuid-комнаты"
  }
}
```

- **type** — Тип события (`playerAction (hit, stand)`, `create_room`, `join_room`, `ready`).
- **content** — Содержание сообщения (ID игрока, действие и т. д.).

### 5.2 Доступные команды

- `ready` — Подтверждение готовности к игре.
- `hit` — Взять карту.
- `stand` — Пропустить ход.
- `create_room` — Создать комнату.
- `join_room` — Присоединиться к существующей комнате.
- `leave_room` — Исключить игрока из комнаты, если у него недостаточно средств.

------

## 6. Управление базами данных

### 6.1 PostgreSQL

Используется для хранения данных пользователей и игр.

### 6.2 Redis

Используется для хранения игровых комнат и быстрого доступа к информации о сессиях.

------

## 7. Запуск проекта

### 7.1 Установка зависимостей

```sh
go mod tidy
```

### 7.2 Запуск сервера

```sh
go run server.go
```

------